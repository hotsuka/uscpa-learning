# USCPA学習管理アプリケーション 要件定義書

**作成日**: 2026年1月17日
**バージョン**: 1.0

---

## 1. プロジェクト概要

### 1.1 目的
USCPA（米国公認会計士）試験に目標期間内で合格するための学習管理アプリケーションを構築する。

### 1.2 背景
- USCPA試験は1,000〜1,500時間の学習が必要とされる
- 効率的な学習には進捗管理と振り返りが重要
- 複数デバイスでの利用ニーズがある

### 1.3 対象ユーザー
- USCPA試験の受験を目指す社会人・学生
- 主に日本在住の日本語話者

---

## 2. 機能要件

### 2.1 学習タイマー機能

| 項目 | 内容 |
|------|------|
| 機能ID | F-001 |
| 優先度 | 必須（MVP） |

#### 機能詳細
- **ストップウォッチモード**: 開始/停止/リセット操作で学習時間を計測
- **ポモドーロモード**: 25分作業 + 5分休憩のサイクル管理
- **科目選択**: 学習開始時に科目を選択（FAR / AUD / REG / BAR）
- **バックグラウンド計測**: ブラウザタブを切り替えても計測継続
- **自動保存**: セッション終了時にデータベースへ自動保存

#### 受け入れ条件
- [x] タイマーが正確に時間を計測できる
- [x] 科目を選択してから計測を開始できる
- [x] 計測終了後、データが正しく保存される

#### 追加実装（v1.2）
- [x] サブテーマ（サブトピック）の選択機能
- [x] 今日の累計学習時間の表示
- [x] タイマー停止時の学習時間を記録ストアに保存

#### 追加実装（v1.3）
- [x] タイマーボタンへのラベル表示（Start/Pause/Resume/Reset/Record）
- [x] ボタン機能の明確化（アイコン+テキスト表示）

#### 追加実装（v1.10）
- [x] タイマー画面に演習記録入力欄を追加（問題数・正答数・メモ）
- [x] 正答率のリアルタイム表示（色分け表示）
- [x] 入力値のlocalStorage永続化
- [x] Recordボタン押下時に記録ダイアログへ値を引き継ぎ

---

### 2.2 過去問演習記録機能

| 項目 | 内容 |
|------|------|
| 機能ID | F-002 |
| 優先度 | 必須（MVP） |

#### 機能詳細
- **日付ごとの記録**: 演習日を指定して記録
- **科目選択**: FAR / AUD / REG / BAR から選択
- **問題数入力**: その日に解いた問題数を記録
- **正解数入力**: 正解した問題数を記録（正答率は自動計算）
- **テーマ/チャプター**: 任意で学習範囲を記録
- **周回数管理**: 問題集を何周目か記録
- **学習時間記録**: 学習に費やした時間を記録（時間+分）
- **サブテーマ選択**: 各科目のサブトピックを選択可能
- **メモ/振り返り**: 自由記述のメモ欄

#### 受け入れ条件
- [x] 過去問の記録を登録・編集・削除できる
- [x] 正答率が自動計算される
- [x] 過去の記録を一覧表示できる

#### 追加実装（v1.2）
- [x] 学習時間フィールドの追加
- [x] タイマーの今日の学習時間をデフォルト値として表示
- [x] 記録一覧での学習時間表示
- [x] テキスト復習タイプの記録対応

#### 追加実装（v1.3）
- [x] 学習記録の詳細表示画面（/records/[id]）
- [x] 学習記録の編集機能（全フィールド編集可能）
- [x] 学習記録の削除機能（確認ダイアログ付き）
- [x] 記録一覧からのクリックで詳細画面へ遷移

---

### 2.3 学習ノート機能

| 項目 | 内容 |
|------|------|
| 機能ID | F-003 |
| 優先度 | 必須（MVP） |

#### 機能詳細
- **テキストエディタ**: Markdown形式での入力対応
- **タイトル**: ノートのタイトルを設定
- **タグ付け**: 科目、テーマ、重要度などのタグを付与
- **科目紐付け**: ノートを科目に紐付け
- **検索機能**: キーワードでノートを検索
- **日付フィルタ**: 作成日・更新日でフィルタリング

#### 受け入れ条件
- [x] ノートを作成・編集・削除できる
- [x] タグで絞り込み検索ができる
- [x] Markdown形式で表示される

#### 追加実装（v1.3）
- [x] ノートストア（notesStore）の実装
- [x] ノートのlocalStorage永続化
- [x] ノートの作成・一覧表示

#### 追加実装（v1.4）
- [x] ノートの詳細表示画面（/notes/[id]）
- [x] ノートの編集機能（タイトル、内容、科目、タグ）
- [x] ノートの削除機能（確認ダイアログ付き）
- [x] タグクリックによるフィルタリング機能
- [x] タグ一覧表示とフィルター選択UI

#### 追加実装（v1.6）
- [x] Markdownプレビュー機能（react-markdown + remark-gfm）
- [x] ノート作成画面での編集/プレビュータブ切り替え
- [x] ノート詳細画面でのMarkdownレンダリング
- [x] Markdown記法のヘルプテキスト表示

---

### 2.7 PDF教材機能

| 項目 | 内容 |
|------|------|
| 機能ID | F-007 |
| 優先度 | 高（追加機能） |

#### 機能詳細
- **PDFアップロード**: ローカルPDFファイルをアップロード
- **IndexedDB保存**: PDFファイルをブラウザのIndexedDBに保存
- **PDFビューア**: react-pdfによる閲覧機能
- **ページナビゲーション**: 前後ページ移動、ページ番号指定
- **ズーム機能**: 拡大/縮小操作

#### 受け入れ条件
- [x] PDFファイルをアップロードできる
- [x] アップロードしたPDFが一覧表示される
- [x] PDFを閲覧でき、ページ移動ができる
- [x] ズーム操作ができる

#### 追加実装（v1.9）
- [x] 教材一覧ページ（/materials）
- [x] 教材詳細ページ（/materials/[id]）
- [x] 教材の削除機能

---

### 2.8 ページ連動メモ機能

| 項目 | 内容 |
|------|------|
| 機能ID | F-008 |
| 優先度 | 高（追加機能） |

#### 機能詳細
- **ページ紐付けメモ**: 各PDFページにメモを記録
- **メモ一覧表示**: 教材内のメモを一覧表示
- **ページジャンプ**: メモ一覧クリックで該当ページへ移動
- **リサイズパネル**: PDFとメモエリアのサイズをドラッグで調整

#### 受け入れ条件
- [x] ページごとにメモを保存できる
- [x] メモ一覧から該当ページにジャンプできる
- [x] PDFとメモの表示幅を調整できる
- [x] メモ入力欄とメモ一覧の高さを調整できる

#### 追加実装（v1.9）
- [x] PageMemo.tsx コンポーネントの実装
- [x] ResizableHorizontalPanel（左右リサイズ）
- [x] ResizableVerticalPanel（上下リサイズ）
- [x] パネルサイズのlocalStorage永続化

#### 追加実装（v1.12）
- [x] メモ未保存警告機能（forwardRef + useImperativeHandle）
- [x] 未保存時の確認ダイアログ（戻るボタン、ページ変更時）
- [x] ブラウザ終了時のbeforeunload警告
- [x] 「未保存」バッジ表示
- [x] PC/モバイルの条件付きレンダリング（useMediaQueryフック）

---

### 2.4 弱点分析・レポート機能

| 項目 | 内容 |
|------|------|
| 機能ID | F-004 |
| 優先度 | 高（追加機能） |

#### 機能詳細
- **科目別正答率グラフ**: 各科目の正答率を棒グラフ/円グラフで表示
- **学習時間推移グラフ**: 日/週/月単位での学習時間推移を折れ線グラフで表示
- **弱点分野リスト**: 正答率が低いテーマを自動特定してリスト表示
- **テーマ別ヒートマップ**: テーマごとの習熟度を色で可視化

#### 受け入れ条件
- [x] 各種グラフが正しく描画される
- [x] 弱点分野が正答率に基づいて特定される
- [x] データがリアルタイムで反映される

#### 追加実装（v1.4）
- [x] 週間学習時間グラフ（直近7日間）
- [x] 科目別統計（学習時間、問題数、正答率）
- [x] 要強化テーマの自動抽出（正答率60%未満）
- [x] 期間フィルター（週間/月間/全期間）

---

### 2.5 試験日カウントダウン機能

| 項目 | 内容 |
|------|------|
| 機能ID | F-005 |
| 優先度 | 高（追加機能） |

#### 機能詳細
- **目標試験日設定**: 各科目の受験予定日を設定
- **残り日数表示**: ダッシュボード上部に残り日数を大きく表示
- **必要学習ペース計算**: 目標達成に必要な1日あたりの学習時間を表示

#### 受け入れ条件
- [x] 試験日を設定・変更できる
- [x] 残り日数が正確に計算される
- [x] 必要ペースが現在の進捗に基づいて計算される

#### 追加実装（v1.2）
- [x] 科目別試験日の設定
- [x] 科目別目標学習時間の設定（推奨時間の表示付き）
- [x] 平日/休日別の目標時間設定
- [x] 祝日考慮の週間目標自動計算（日本の祝日データ2025-2027年）

#### 追加実装（v1.3）
- [x] 試験日見込み学習時間の表示
- [x] 残り日数・見込み時間・残り必要時間の表示
- [x] 目標達成可否の判定と視覚的フィードバック
  - 緑色: 「現在のペースで目標達成可能」
  - 赤色: 「あと○時間不足（1日+○h必要）」
- [x] 設定ストア（settingsStore）によるlocalStorage永続化

#### 追加実装（v1.6）
- [x] ダッシュボードでの科目別必要学習ペース表示
- [x] 残り学習時間と1日あたり必要時間（○h/日）の表示
- [x] 目標達成見込みの視覚的フィードバック（緑：達成可能、オレンジ：要ペースアップ）

---

### 2.6 デバイス間データ同期機能

| 項目 | 内容 |
|------|------|
| 機能ID | F-006 |
| 優先度 | 必須（MVP） |

#### 設計方針（v1.11改訂）
- **ローカルファースト**: localStorageを主データソースとして使用
- **Notion同期**: Notion APIをデバイス間同期のバックエンドとして使用
- **認証なし**: プライベートInternal Integrationを使用（Notion OAuth不要）
- **Notion直接編集なし**: ユーザーはアプリからのみデータを操作

#### 機能詳細
- **初回同期**: アプリ起動時にNotionからデータをフェッチしlocalStorageと比較
- **書き込み同期**: localStorageへの保存と同時にNotion APIを呼び出し
- **競合解決**: 更新日時（updatedAt）とデバイスIDで判定、新しい更新を優先（Last-Write-Wins）
- **オフライン対応**: オフライン時はキューに蓄積、オンライン復帰時に一括同期
- **デバイスID**: 初回起動時にUUIDを生成してlocalStorageに保存

#### Notionデータベース構成
1. **設定 (Settings)**: 目標時間、試験日、デバイスID
2. **学習セッション (Study Sessions)**: タイマー生データ（読み取り専用、監査用）
3. **学習記録 (Practice Records)**: 確定データ（編集可能）、source/sessionIdで作成元を追跡
4. **学習ノート (Study Notes)**: ノート + ページメモ統合（noteTypeで識別）

#### 受け入れ条件
- [ ] 複数デバイス間でデータが同期される
- [ ] オフライン時の操作がオンライン復帰後に同期される
- [ ] タイマーのセッション情報が学習記録と紐付けられる
- [ ] ページメモがノートDBに統合されて同期される

#### 追加実装（v1.12）
- [x] アプリ起動時のNotion同期機能（SyncProvider）
- [x] useSyncOnMountフック（初回マウント時に同期、5分間隔チェック）
- [x] useSyncOnOnlineフック（オンライン復帰時に同期）
- [x] メインレイアウトへのSyncProvider統合

---

## 3. 非機能要件

### 3.1 パフォーマンス
- ページ読み込み: 3秒以内
- タイマー精度: 誤差1秒以内
- データ同期: 5秒以内

### 3.2 可用性
- サービス稼働率: 99%以上
- 計画メンテナンス時は事前通知

### 3.3 セキュリティ
- 通信の暗号化（HTTPS）
- Row Level Security（RLS）によるデータアクセス制御
- パスワードのハッシュ化保存

### 3.4 対応環境
| デバイス | ブラウザ |
|----------|----------|
| PC（Windows/Mac） | Chrome, Firefox, Edge, Safari |
| スマートフォン（iOS/Android） | Safari, Chrome |
| タブレット | Safari, Chrome |

### 3.5 アクセシビリティ
- レスポンシブデザイン対応
- キーボード操作対応
- 十分なコントラスト比の確保

---

## 4. データ設計

### 4.1 エンティティ関連図

```
┌─────────────┐       ┌──────────────────┐
│   profiles  │───┬───│  study_sessions  │
│  (ユーザー)  │   │   │  (学習セッション) │
└─────────────┘   │   └──────────────────┘
                  │
                  ├───┌──────────────────┐
                  │   │ practice_records │
                  │   │  (過去問記録)     │
                  │   └──────────────────┘
                  │
                  └───┌──────────────────┐
                      │   study_notes    │
                      │  (学習ノート)     │
                      └──────────────────┘
```

### 4.2 テーブル定義

#### profiles（ユーザープロファイル）
| カラム名 | 型 | 制約 | 説明 |
|----------|------|------|------|
| id | uuid | PK | ユーザーID（auth.usersと連携） |
| email | text | NOT NULL | メールアドレス |
| exam_date | date | - | 目標試験日 |
| target_hours | int | - | 目標学習時間（時間） |
| created_at | timestamp | NOT NULL | 作成日時 |

#### study_sessions（学習セッション）
| カラム名 | 型 | 制約 | 説明 |
|----------|------|------|------|
| id | uuid | PK | セッションID |
| user_id | uuid | FK | ユーザーID |
| subject | text | NOT NULL | 科目（FAR/AUD/REG/BAR） |
| duration_seconds | int | NOT NULL | 学習時間（秒） |
| started_at | timestamp | NOT NULL | 開始日時 |
| ended_at | timestamp | NOT NULL | 終了日時 |
| created_at | timestamp | NOT NULL | 作成日時 |

#### practice_records（過去問演習記録）
| カラム名 | 型 | 制約 | 説明 |
|----------|------|------|------|
| id | uuid | PK | 記録ID |
| user_id | uuid | FK | ユーザーID |
| subject | text | NOT NULL | 科目 |
| topic | text | - | テーマ/チャプター |
| total_questions | int | NOT NULL | 問題数 |
| correct_answers | int | NOT NULL | 正解数 |
| round_number | int | DEFAULT 1 | 周回数 |
| practiced_at | date | NOT NULL | 演習日 |
| created_at | timestamp | NOT NULL | 作成日時 |

#### study_notes（学習ノート）
| カラム名 | 型 | 制約 | 説明 |
|----------|------|------|------|
| id | uuid | PK | ノートID |
| user_id | uuid | FK | ユーザーID |
| title | text | NOT NULL | タイトル |
| content | text | - | 本文（Markdown） |
| tags | text[] | - | タグ配列 |
| subject | text | - | 科目 |
| created_at | timestamp | NOT NULL | 作成日時 |
| updated_at | timestamp | NOT NULL | 更新日時 |

---

## 5. 画面設計

### 5.1 画面一覧

| 画面ID | 画面名 | 説明 |
|--------|--------|------|
| S-001 | ログイン/サインアップ | 認証画面 |
| S-002 | ダッシュボード | ホーム画面、サマリー表示 |
| S-003 | タイマー | 学習時間計測画面 |
| S-004 | 過去問記録 | 演習記録の入力・一覧 |
| S-005 | 学習ノート | ノートの作成・一覧・検索 |
| S-006 | 分析・レポート | グラフ・弱点分析表示 |
| S-007 | 設定 | プロファイル・目標設定 |

### 5.2 画面遷移図

```
                    ┌─────────────┐
                    │   ログイン   │
                    └──────┬──────┘
                           │
                           ▼
┌──────────────────────────────────────────────────┐
│                  ダッシュボード                    │
│  ┌────────────────────────────────────────────┐  │
│  │ カウントダウン │ 今日のサマリー │ 進捗バー │  │
│  └────────────────────────────────────────────┘  │
└──────────────────────────────────────────────────┘
         │         │         │         │
         ▼         ▼         ▼         ▼
    ┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐
    │タイマー│ │過去問  │ │ノート  │ │ 分析   │
    │        │ │ 記録   │ │        │ │レポート│
    └────────┘ └────────┘ └────────┘ └────────┘
```

---

## 6. 技術仕様

### 6.1 技術スタック

| レイヤー | 技術 | バージョン |
|----------|------|------------|
| フロントエンド | Next.js (App Router) | 14.x |
| 言語 | TypeScript | 5.x |
| スタイリング | Tailwind CSS | 3.x |
| UIコンポーネント | shadcn/ui | latest |
| PWA | next-pwa | latest |
| バックエンド | Supabase | - |
| データベース | PostgreSQL（Supabase） | 15.x |
| 認証 | Supabase Auth | - |
| ホスティング | Vercel | - |

### 6.2 システム構成図

```
┌─────────────────────────────────────────────────────────┐
│                      クライアント                        │
│  ┌─────────┐  ┌─────────┐  ┌─────────┐                 │
│  │   PC    │  │ スマホ  │  │タブレット│                 │
│  │ブラウザ │  │ブラウザ │  │ブラウザ │                 │
│  └────┬────┘  └────┬────┘  └────┬────┘                 │
└───────┼────────────┼────────────┼──────────────────────┘
        │            │            │
        └────────────┼────────────┘
                     │ HTTPS
                     ▼
        ┌────────────────────────┐
        │        Vercel          │
        │   (Next.js ホスト)      │
        └───────────┬────────────┘
                    │
                    ▼
        ┌────────────────────────┐
        │       Supabase         │
        │  ┌──────────────────┐  │
        │  │   PostgreSQL     │  │
        │  │   (データベース)   │  │
        │  └──────────────────┘  │
        │  ┌──────────────────┐  │
        │  │   Auth           │  │
        │  │   (認証)          │  │
        │  └──────────────────┘  │
        │  ┌──────────────────┐  │
        │  │   Realtime       │  │
        │  │   (リアルタイム同期)│  │
        │  └──────────────────┘  │
        └────────────────────────┘
```

---

## 7. 開発スケジュール

### Phase 1: プロジェクトセットアップ
- Next.js プロジェクト作成
- Tailwind CSS + shadcn/ui セットアップ
- Supabaseアカウント作成・プロジェクト設定
- 環境変数設定
- 認証機能実装

### Phase 2: コア機能開発
- データベーススキーマ作成
- タイマー機能実装
- 過去問記録機能実装
- 学習ノート機能実装

### Phase 3: 分析・ダッシュボード
- ダッシュボード画面実装
- 学習時間グラフ実装
- 正答率分析実装
- カウントダウン機能実装

### Phase 4: PWA対応・リリース
- PWA設定（Service Worker、manifest）
- オフライン対応
- レスポンシブデザイン調整
- Vercelデプロイ

---

## 8. 用語集

| 用語 | 説明 |
|------|------|
| USCPA | 米国公認会計士（U.S. Certified Public Accountant） |
| FAR | Financial Accounting and Reporting（財務会計） |
| AUD | Auditing and Attestation（監査と証明業務） |
| REG | Taxation and Regulation（税法と商法） |
| BAR | Business Analysis and Reporting（ビジネス分析と報告） |
| PWA | Progressive Web App（プログレッシブウェブアプリ） |
| MVP | Minimum Viable Product（実用最小限の製品） |
| RLS | Row Level Security（行レベルセキュリティ） |

---

## 9. 参考資料

- [Studyplus](https://apps.apple.com/jp/app/studyplus-スタディプラス-日々の学習管理に/id505410049) - 学習管理アプリの参考
- [USCPAどこのブログ - 学習スケジュール](https://www.dokoblog.com/uscpa-study-plan/) - USCPA学習計画の参考
- [Spaced Repetition Guide](https://makeheadway.com/blog/spaced-repetition-app/) - 間隔反復学習の参考
- [Supabase Documentation](https://supabase.com/docs) - バックエンド技術ドキュメント
- [Next.js Documentation](https://nextjs.org/docs) - フロントエンド技術ドキュメント

---

## 改訂履歴

| バージョン | 日付 | 内容 | 担当 |
|------------|------|------|------|
| 1.0 | 2026-01-17 | 初版作成 | - |
| 1.1 | 2026-01-18 | 学習時間管理、祝日対応週間目標、PDF教材ビューアの追加実装を反映 | - |
| 1.2 | 2026-01-18 | 設定/ノート永続化、学習記録編集・削除、試験日見込み時間表示、タイマーボタンラベル追加を反映 | - |
| 1.3 | 2026-01-18 | ノート編集・削除、タグフィルタリング、弱点分析機能の完了を反映 | - |
| 1.4 | 2026-01-19 | PDF教材機能（IndexedDB保存）、ページ連動メモ機能、リサイズ可能パネルを追加 | - |
| 1.5 | 2026-01-19 | タイマー画面に演習記録入力欄（問題数・正答数・メモ）、記録ダイアログへの値引き継ぎを追加 | - |
| 1.6 | 2026-01-19 | F-006をデバイス間データ同期機能に改訂（Notion同期、4DB構成、Sessions/Records分離） | - |
| 1.7 | 2026-01-20 | メモ未保存警告機能、アプリ起動時Notion同期、useMediaQueryフックを追加 | - |
